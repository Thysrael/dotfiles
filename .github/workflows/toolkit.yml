name: Build Multi-Arch Toolkit

on:
  workflow_dispatch:
  schedule:
    - cron: '0 4 1 */3 *' # every season on the 1st at 04:00 UTC

permissions:
  contents: write

jobs:
  # === JOB 1: prepare version tag ===
  prepare:
    runs-on: ubuntu-latest
    outputs:
      tag_name: ${{ steps.date.outputs.date }}
    steps:
      - name: Get current date
        id: date
        run: echo "date=v$(date +'%Y.%m.%d-%H%M')" >> $GITHUB_OUTPUT

  # === JOB 2: build (amd64 & arm64) ===
  build:
    needs: prepare
    runs-on: ubuntu-latest
    strategy:
      fail-fast: false
      matrix:
        # Define the architectures you want to support here
        arch: [amd64, arm64]

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Install eget
        run: curl https://zyedidia.github.io/eget.sh | sh

      - name: Download Tools for linux/${{ matrix.arch }}
        run: |
          TARGET="linux/${{ matrix.arch }}"
          OUT="bin"
          mkdir -p $OUT

          if [ "${{ matrix.arch }}" = "amd64" ]; then
            RUST_ARCH="x86_64"
            MATCH_STR="x86_64-unknown-linux-musl"
          elif [ "${{ matrix.arch }}" = "arm64" ]; then
            RUST_ARCH="aarch64"
            MATCH_STR="aarch64-unknown-linux-gnu"
          fi

          echo "ðŸš€ Architecture: $TARGET"
          echo "ðŸŽ¯ Strict Match: $MATCH_STR"

          # === ðŸ“¥ Tools List ===
          # Format: ./eget <repo> --system $TARGET --to $OUT/ <optional: --tag v1.0.0>

          # 1. bat
          echo "â¬‡ï¸ bat..."
          ./eget sharkdp/bat --system $TARGET --asset "musl" --asset "tar.gz" --to $OUT/

          # 2. fd
          echo "â¬‡ï¸ fd..."
          ./eget sharkdp/fd --system $TARGET --asset "musl" --asset "tar.gz" --to $OUT/

          # 3. fzf (fzf release package structure is special, directly download binary)
          echo "â¬‡ï¸ fzf..."
          ./eget junegunn/fzf --system $TARGET --asset "tar.gz" --to $OUT/

          # 4. lazygit
          echo "â¬‡ï¸ lazygit..."
          ./eget jesseduffield/lazygit --system $TARGET --to $OUT/

          # 5. lsd
          echo "â¬‡ï¸ lsd..."
          ./eget lsd-rs/lsd --system $TARGET --asset "musl" --asset "tar.gz" --to $OUT/

          # 6. ripgrep (rg)
          echo "â¬‡ï¸ ripgrep..."
          ./eget BurntSushi/ripgrep --asset "$MATCH_STR" --system $TARGET --to $OUT/rg

          # 7. zoxide
          echo "â¬‡ï¸ zoxide..."
          ./eget ajeetdsouza/zoxide --system $TARGET --asset "musl" --asset "tar.gz" --to $OUT/

          # === âœ… Packaging ===
          echo "ðŸ“¦ Compressing..."
          TAR_NAME="toolkit-${{ matrix.arch }}.tar.gz"
          tar -czvf $TAR_NAME -C $OUT .

          # Store the name of the package file in an environment variable for the next upload step
          echo "TAR_NAME=$TAR_NAME" >> $GITHUB_ENV

      - name: Upload Artifact
        uses: actions/upload-artifact@v4
        with:
          name: toolkit-${{ matrix.arch }}
          path: ${{ env.TAR_NAME }}

  # === JOB 3: unified release ===
  release:
    needs: [prepare, build]
    runs-on: ubuntu-latest
    steps:
      - name: Download all artifacts
        uses: actions/download-artifact@v4
        with:
          path: dist
          merge-multiple: true # Merge all artifacts into the same directory
      - name: Display structure of downloaded files
        run: ls -R dist

      - name: Create Release
        uses: softprops/action-gh-release@v1
        with:
          tag_name: ${{ needs.prepare.outputs.tag_name }}
          name: Toolkit ${{ needs.prepare.outputs.tag_name }}
          files: dist/*.tar.gz
          draft: false
          prerelease: false
          generate_release_notes: true